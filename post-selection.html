<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPRC Client Portal - Post-Selection Pipeline</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/tprc-brand.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body class="post-selection-page">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-tprc-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <svg width="153" height="50" viewBox="0 0 153 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M27.4569 33.4243C25.1365 38.3108 20.1736 41.6685 14.4464 41.6685C6.46975 41.6685 0 35.1332 0 27.0692C0 19.0052 6.46975 12.47 14.4464 12.47C20.6541 12.47 25.8299 16.4173 27.9319 21.9972C23.9135 23.8262 21.6368 21.4785 21.6368 21.4785C19.9771 19.2782 17.3673 17.8587 14.43 17.8587C9.41799 17.8587 5.36143 21.9808 5.36143 27.0638C5.36143 32.1467 9.42345 36.2688 14.43 36.2688C17.1216 36.2688 19.5403 35.0786 21.2055 33.1896C21.2055 33.1896 24.0445 33.943 27.4623 33.4298L27.4569 33.4243Z" fill="#939D9E"></path>
                <path d="M12.0987 9.91479C14.419 5.02835 19.3819 1.67064 25.1091 1.67064C33.0858 1.67064 39.5555 8.2059 39.5555 16.2699C39.5555 24.3339 33.0858 30.8691 25.1091 30.8691C18.9014 30.8691 13.7256 26.9218 11.6237 21.342C15.642 19.513 17.9187 21.8606 17.9187 21.8606C19.5784 24.0609 22.1882 25.4804 25.1255 25.4804C30.1375 25.4804 34.1941 21.3583 34.1941 16.2753C34.1941 11.1924 30.1321 7.07028 25.1255 7.07028C22.4339 7.07028 20.0152 8.2605 18.35 10.1496C18.35 10.1496 15.511 9.39612 12.0932 9.90933L12.0987 9.91479Z" fill="#FF4C00"></path>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M50.6497 13.8185V30.0666H50.6442C50.6442 36.5909 54.4442 39.1406 60.2533 39.1406C61.8584 39.1406 63.338 38.9605 64.6429 38.6056V32.9111C63.5182 33.0312 62.9831 33.0312 62.2734 33.0312C59.0685 33.0312 58.2386 31.5516 58.2386 28.8818V13.8185H64.288V7.88927H58.2386V0H50.6497V7.88927H45.4902V13.8185H50.6497ZM76.7962 7.8893H69.2072V50H76.7962V34.287C78.2812 37.1915 81.841 39.3263 86.3452 39.3263C92.9842 39.3263 99.9235 34.5818 99.9235 23.313C99.9235 12.0441 92.9897 7.29965 86.3452 7.29965C81.8355 7.29965 78.2812 9.43439 76.7962 12.339V7.8893ZM92.8095 23.3075C92.8095 29.9465 88.8348 32.9712 84.5653 32.9712C80.416 32.9712 76.4413 29.9465 76.4413 23.3075C76.4413 16.6685 80.2959 13.6438 84.5653 13.6438C88.8348 13.6438 92.8095 16.6685 92.8095 23.3075ZM103.669 7.88924H111.252V15.2435H111.433C112.443 11.0941 115.347 7.53436 120.567 7.53436C121.276 7.53436 122.106 7.59441 122.936 7.82918V14.2334C122.046 14.1133 121.336 14.0532 120.567 14.0532C115.467 14.0532 111.258 17.138 111.258 24.3721V38.7202H103.669V7.88924ZM139.004 7.29414C131.295 7.29414 123.646 11.9786 123.646 23.3621C123.646 34.751 131.295 39.3153 139.004 39.3153C144.464 39.3153 151.873 37.0059 152.823 27.1019H145.943C145.168 31.1913 142.558 32.9111 138.944 32.9111C133.664 32.9111 130.76 29.1712 130.76 23.3621C130.76 17.5529 133.664 13.6984 138.944 13.6984C142.444 13.6984 145.174 15.3035 145.943 19.4529H152.823C151.692 9.48894 144.398 7.29414 139.004 7.29414Z" fill="#FF4C00"></path>
                </svg>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="company-profile.html">
                            <i class="fas fa-building me-1"></i>Company Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="documents.html">
                            <i class="fas fa-file-upload me-1"></i>Documents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="support.html">
                            <i class="fas fa-life-ring me-1"></i>Support
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i>
                            <span id="user-name">Loading...</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="company-profile.html">
                                <i class="fas fa-building me-2"></i>Company Profile
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-btn">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container-fluid mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item active">Post-Selection Pipeline</li>
            </ol>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-2">Post-Selection Pipeline</h2>
                                <p class="mb-0 text-muted">Track your selected candidates through the deployment process</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshPipeline()">
                                        <i class="fas fa-sync-alt me-1"></i>Refresh
                                    </button>
                                    <button class="btn btn-tprc-primary btn-sm" onclick="exportPipelineReport()">
                                        <i class="fas fa-download me-1"></i>Export Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-clipboard-check fa-2x mb-2"></i>
                        <h3 id="selected-count">0</h3>
                        <h6>Selected Candidates</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-file-medical fa-2x mb-2"></i>
                        <h3 id="visa-processing-count">0</h3>
                        <h6>Visa Processing</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-plane fa-2x mb-2"></i>
                        <h3 id="deployment-ready-count">0</h3>
                        <h6>Deployment Ready</h6>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-briefcase fa-2x mb-2"></i>
                        <h3 id="deployed-count">0</h3>
                        <h6>Successfully Deployed</h6>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Candidates Pipeline -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-route me-2"></i>Deployment Pipeline
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="pipeline-content">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0">Loading pipeline data...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Detail Modal -->
    <div class="modal fade" id="pipelineDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pipeline Progress Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="pipeline-detail-content">
                        <!-- Content loaded dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/hubspot-api.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (!isAuthenticated()) {
                window.location.href = 'index.html';
                return;
            }
            
            // Initialize the page
            initializePostSelectionPage();
        });

        async function initializePostSelectionPage() {
            try {
                // Load user profile for navigation
                await loadUserProfile();
                
                // Load pipeline data
                await loadPipelineData();
                
            } catch (error) {
                console.error('Error initializing post-selection page:', error);
                showErrorMessage('Failed to load pipeline data');
            }
        }

        async function loadPipelineData() {
            try {
                // Fetch selected candidates and their pipeline status
                const response = await hubspotAPI.request('/api/hubspot/post-selection/pipeline');
                const pipelineData = response;

                // Update overview counts
                updatePipelineCounts(pipelineData);
                
                // Render pipeline view
                renderPipelineView(pipelineData.candidates || []);
                
            } catch (error) {
                console.error('Error loading pipeline data:', error);
                document.getElementById('pipeline-content').innerHTML = 
                    '<div class="alert alert-danger">Failed to load pipeline data</div>';
            }
        }

        function updatePipelineCounts(data) {
            document.getElementById('selected-count').textContent = data.stats?.selected || 0;
            document.getElementById('visa-processing-count').textContent = data.stats?.visa_processing || 0;
            document.getElementById('deployment-ready-count').textContent = data.stats?.deployment_ready || 0;
            document.getElementById('deployed-count').textContent = data.stats?.deployed || 0;
        }

        function renderPipelineView(candidates) {
            const content = document.getElementById('pipeline-content');
            
            if (!candidates || candidates.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5>No candidates in pipeline</h5>
                        <p class="text-muted">Selected candidates will appear here once they enter the deployment process.</p>
                    </div>
                `;
                return;
            }

            content.innerHTML = candidates.map(candidate => createCandidateCard(candidate)).join('');
        }

        function createCandidateCard(candidate) {
            const progressPercentage = calculateProgress(candidate.pipeline_stage);
            const stageClass = getStageClass(candidate.pipeline_stage);
            
            return `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <i class="fas fa-user-circle fa-2x text-muted"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">${candidate.name}</h6>
                                        <small class="text-muted">${candidate.position}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <span class="badge ${stageClass}">${candidate.pipeline_stage}</span>
                            </div>
                            <div class="col-md-4">
                                <div class="progress mb-1" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${progressPercentage}%" 
                                         aria-valuenow="${progressPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <small class="text-muted">${progressPercentage}% Complete</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-outline-primary btn-sm" onclick="showPipelineDetails('${candidate.id}')">
                                    <i class="fas fa-eye me-1"></i>Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateProgress(stage) {
            const stages = {
                'Letter of Offer': 20,
                'Visa Processing': 40,
                'Medical Examination': 60,
                'COE Approval': 80,
                'Deployment Prep': 90,
                'Deployed': 100
            };
            return stages[stage] || 0;
        }

        function getStageClass(stage) {
            const classes = {
                'Letter of Offer': 'bg-info',
                'Visa Processing': 'bg-warning',
                'Medical Examination': 'bg-primary',
                'COE Approval': 'bg-secondary',
                'Deployment Prep': 'bg-success',
                'Deployed': 'bg-dark'
            };
            return classes[stage] || 'bg-light text-dark';
        }

        function showPipelineDetails(candidateId) {
            // Implementation for showing detailed pipeline progress
            console.log('Show pipeline details for candidate:', candidateId);
        }

        function refreshPipeline() {
            loadPipelineData();
        }

        function exportPipelineReport() {
            // Implementation for exporting pipeline report
            console.log('Export pipeline report');
        }

        function showErrorMessage(message) {
            // Show error message to user
            console.error(message);
        }
    </script>
</body>
</html>