<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPRC Client Portal - Document Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/tprc-brand.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
</head>
<body class="documents-page">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-tprc-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <svg width="40" height="20" viewBox="0 0 120 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="120" height="60" rx="8" fill="white"/>
                    <text x="60" y="35" text-anchor="middle" fill="#2C5282" font-family="Arial, sans-serif" font-weight="bold" font-size="18">TPRC</text>
                </svg>
                <span class="ms-2">Client Portal</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="company-profile.html">
                            <i class="fas fa-building me-1"></i>Company Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="documents.html">
                            <i class="fas fa-file-upload me-1"></i>Documents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="support.html">
                            <i class="fas fa-life-ring me-1"></i>Support
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="post-selection.html">
                            <i class="fas fa-route me-1"></i>Pipeline
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i>
                            <span id="user-name">Loading...</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="company-profile.html" id="company-profile">
                                <i class="fas fa-building me-2"></i>Company Profile
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-btn">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>Document Management</h2>
                        <p class="text-muted mb-0">Upload and manage your sponsorship and nomination documents</p>
                    </div>
                    <button class="btn btn-tprc-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="fas fa-upload me-2"></i>Upload Documents
                    </button>
                </div>
            </div>
        </div>

        <!-- Upload Progress -->
        <div class="row mb-4" id="upload-progress-section" style="display: none;">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-cloud-upload-alt me-2 text-info"></i>Upload in Progress
                        </h6>
                        <div class="progress mb-2">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="upload-progress-bar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="upload-status">Preparing upload...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Categories -->
        <div class="row">
            <!-- Sponsorship Documents -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-handshake me-2 text-primary"></i>Sponsorship Documents
                        </h5>
                        <span class="badge bg-primary" id="sponsorship-count">0/5</span>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Required documents for sponsorship applications</p>
                        
                        <div class="document-checklist">
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Company Registration Certificate</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Official company registration document</small>
                                <div class="ms-4 mt-2" id="doc-company-cert" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Financial Statements</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Latest audited financial statements</small>
                                <div class="ms-4 mt-2" id="doc-financial" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Labour Market Testing</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Evidence of labour market testing efforts</small>
                                <div class="ms-4 mt-2" id="doc-lmt" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Organizational Chart</strong>
                                    </div>
                                    <span class="badge bg-warning">Optional</span>
                                </div>
                                <small class="text-muted ms-4">Current company organizational structure</small>
                                <div class="ms-4 mt-2" id="doc-org-chart" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Training Plan</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Detailed training plan for sponsored employees</small>
                                <div class="ms-4 mt-2" id="doc-training-plan" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nomination Documents -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-user-plus me-2 text-success"></i>Nomination Documents
                        </h5>
                        <span class="badge bg-success" id="nomination-count">0/5</span>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Required documents for candidate nominations</p>
                        
                        <div class="document-checklist">
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Job Description</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Detailed job description for the position</small>
                                <div class="ms-4 mt-2" id="doc-job-desc" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Employment Contract</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Signed employment contract</small>
                                <div class="ms-4 mt-2" id="doc-contract" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Skills Assessment</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Professional skills assessment results</small>
                                <div class="ms-4 mt-2" id="doc-skills" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Salary Evidence</strong>
                                    </div>
                                    <span class="badge bg-secondary">Required</span>
                                </div>
                                <small class="text-muted ms-4">Evidence of salary package</small>
                                <div class="ms-4 mt-2" id="doc-salary" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                            
                            <div class="checklist-item mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="fas fa-circle-check text-success me-2" style="display: none;"></i>
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <strong>Supporting Documents</strong>
                                    </div>
                                    <span class="badge bg-warning">Optional</span>
                                </div>
                                <small class="text-muted ms-4">Additional supporting documentation</small>
                                <div class="ms-4 mt-2" id="doc-supporting" style="display: none;">
                                    <!-- Document details will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Questions Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-question-circle me-2 text-info"></i>Additional Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">Please answer the following questions to complete your application</p>
                        
                        <form id="additional-questions-form">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Business Size (Number of Employees)</label>
                                    <select class="form-select" name="business_size">
                                        <option value="">Select business size</option>
                                        <option value="1-10">1-10 employees</option>
                                        <option value="11-50">11-50 employees</option>
                                        <option value="51-200">51-200 employees</option>
                                        <option value="201+">201+ employees</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Annual Turnover</label>
                                    <select class="form-select" name="annual_turnover">
                                        <option value="">Select turnover range</option>
                                        <option value="under-2m">Under $2M</option>
                                        <option value="2m-10m">$2M - $10M</option>
                                        <option value="10m-50m">$10M - $50M</option>
                                        <option value="over-50m">Over $50M</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Years in Business</label>
                                <input type="number" class="form-control" name="years_in_business" min="0" max="100">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Primary Industry Sector</label>
                                <input type="text" class="form-control" name="industry_sector" placeholder="e.g., Technology, Healthcare, Manufacturing">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Previous Sponsorship Experience</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="previous_sponsorship" value="yes" id="prev-yes">
                                    <label class="form-check-label" for="prev-yes">Yes, we have sponsored employees before</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="previous_sponsorship" value="no" id="prev-no">
                                    <label class="form-check-label" for="prev-no">No, this is our first sponsorship</label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Additional Comments</label>
                                <textarea class="form-control" name="additional_comments" rows="4" placeholder="Any additional information you'd like to provide..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-tprc-primary">
                                <i class="fas fa-save me-2"></i>Save Information
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Documents</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="document-category" class="form-label">Document Category *</label>
                            <select class="form-select" id="document-category" name="category" required>
                                <option value="">Select category</option>
                                <option value="sponsorship">Sponsorship Documents</option>
                                <option value="nomination">Nomination Documents</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="document-type" class="form-label">Document Type *</label>
                            <select class="form-select" id="document-type" name="type" required>
                                <option value="">Select document type</option>
                                <!-- Options will be populated based on category -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="document-files" class="form-label">Select Files *</label>
                            <input type="file" class="form-control" id="document-files" name="files" multiple required accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                            <div class="form-text">
                                Accepted formats: PDF, DOC, DOCX, JPG, PNG. Maximum 10MB per file.
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="document-description" class="form-label">Description</label>
                            <textarea class="form-control" id="document-description" name="description" rows="3" placeholder="Optional description or notes about the documents"></textarea>
                        </div>
                        
                        <div id="file-preview" class="mb-3" style="display: none;">
                            <h6>Selected Files:</h6>
                            <div id="file-list"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-tprc-primary" id="upload-btn">
                        <i class="fas fa-upload me-2"></i>Upload Documents
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/hubspot-api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let uploadedDocuments = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            if (!isAuthenticated()) {
                window.location.href = 'index.html';
                return;
            }
            
            // Load existing documents
            loadDocuments();
            
            // Setup event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Logout
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Document category change
            document.getElementById('document-category').addEventListener('change', updateDocumentTypes);
            
            // File selection
            document.getElementById('document-files').addEventListener('change', previewFiles);
            
            // Upload button
            document.getElementById('upload-btn').addEventListener('click', uploadDocuments);
            
            // Additional questions form
            document.getElementById('additional-questions-form').addEventListener('submit', saveAdditionalInfo);
        }

        function updateDocumentTypes() {
            const category = document.getElementById('document-category').value;
            const typeSelect = document.getElementById('document-type');
            
            typeSelect.innerHTML = '<option value="">Select document type</option>';
            
            if (category === 'sponsorship') {
                typeSelect.innerHTML += `
                    <option value="company-cert">Company Registration Certificate</option>
                    <option value="financial">Financial Statements</option>
                    <option value="lmt">Labour Market Testing</option>
                    <option value="org-chart">Organizational Chart</option>
                    <option value="training-plan">Training Plan</option>
                `;
            } else if (category === 'nomination') {
                typeSelect.innerHTML += `
                    <option value="job-desc">Job Description</option>
                    <option value="contract">Employment Contract</option>
                    <option value="skills">Skills Assessment</option>
                    <option value="salary">Salary Evidence</option>
                    <option value="supporting">Supporting Documents</option>
                `;
            }
        }

        function previewFiles() {
            const files = document.getElementById('document-files').files;
            const fileList = document.getElementById('file-list');
            const preview = document.getElementById('file-preview');
            
            fileList.innerHTML = '';
            
            if (files.length > 0) {
                preview.style.display = 'block';
                
                Array.from(files).forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item d-flex justify-content-between align-items-center p-2 bg-light rounded mb-2';
                    fileItem.innerHTML = `
                        <div>
                            <i class="fas fa-file me-2"></i>
                            <span>${file.name}</span>
                            <small class="text-muted ms-2">(${formatFileSize(file.size)})</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
            } else {
                preview.style.display = 'none';
            }
        }

        function removeFile(index) {
            const input = document.getElementById('document-files');
            const dt = new DataTransfer();
            
            Array.from(input.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            
            input.files = dt.files;
            previewFiles();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function uploadDocuments() {
            const form = document.getElementById('upload-form');
            const formData = new FormData(form);
            
            // Validate form
            if (!formData.get('category') || !formData.get('type') || !formData.get('files').name) {
                alert('Please fill in all required fields and select files');
                return;
            }
            
            // Show progress
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
            modal.hide();
            
            const progressSection = document.getElementById('upload-progress-section');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status');
            
            progressSection.style.display = 'block';
            statusText.textContent = 'Uploading documents...';
            
            // Simulate upload progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                
                if (progress >= 100) {
                    clearInterval(interval);
                    statusText.textContent = 'Upload completed successfully!';
                    
                    setTimeout(() => {
                        progressSection.style.display = 'none';
                        loadDocuments(); // Refresh document list
                        form.reset();
                        document.getElementById('file-preview').style.display = 'none';
                    }, 2000);
                }
            }, 200);
        }

        function saveAdditionalInfo(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Save to HubSpot
            saveAdditionalInfoToHubSpot(data)
                .then(response => {
                    showAlert('success', 'Additional information saved successfully!');
                })
                .catch(error => {
                    console.error('Error saving additional info:', error);
                    showAlert('danger', 'Failed to save information. Please try again.');
                });
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
