<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPRC Client Portal - Applicant Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/tprc-brand.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="icon" href="https://tprc.com.au/wp-content/themes/digitalcreative/img/favs/favicon.png">
</head>
<body class="applicant-page">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-tprc-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <img width="125" src="https://tprc.com.au/wp-content/uploads/2025/01/tprc-logo-web.svg"  style="max-width: 100%; height: auto;" decoding="async" loading="lazy">
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="company-profile.html">
                            <i class="fas fa-building me-1"></i>Company Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="documents.html">
                            <i class="fas fa-file-upload me-1"></i>Documents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="support.html">
                            <i class="fas fa-life-ring me-1"></i>Support
                        </a>
                    </li>

                </ul>
                
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i>
                            <span id="user-name">Loading...</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="company-profile.html" id="company-profile">
                                <i class="fas fa-building me-2"></i>Company Profile
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logout-btn">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container-fluid mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="#" id="job-order-link">Job Order</a></li>
                <li class="breadcrumb-item active">Applicant Profile</li>
            </ol>
        </nav>
    </div>

    <!-- Alert Container -->
    <div class="container-fluid">
        <div id="alert-container"></div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Applicant Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <div class="applicant-avatar mb-3">
                                    <i class="fas fa-user-circle fa-5x text-muted" id="applicant-avatar"></i>
                                </div>
                                <span class="badge bg-secondary" id="applicant-status">Status</span>
                            </div>
                            <div class="col-md-7">
                                <h2 class="mb-2" id="applicant-name">Loading...</h2>
                                <div class="d-flex flex-wrap gap-3 mb-3">
                                    <span><i class="fas fa-birthday-cake text-muted me-1"></i><span id="applicant-age">-</span> years old</span>
                                    <span><i class="fas fa-map-marker-alt text-muted me-1"></i><span id="applicant-location">-</span></span>
                                    <span><i class="fas fa-envelope text-muted me-1"></i><span id="applicant-email">-</span></span>
                                    <span><i class="fas fa-phone text-muted me-1"></i><span id="applicant-phone">-</span></span>
                                </div>
                                <p class="mb-0 text-muted" id="applicant-summary">Loading applicant summary...</p>
                            </div>
                            <div class="col-md-3 text-end">
                                <div class="text-muted small">
                                    <div><strong>Applied:</strong> <span id="applied-date">-</span></div>
                                    <div><strong>Status:</strong> <span id="application-status">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applicant Details Tabs -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>Applicant Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="applicantTabsContent">
                            <!-- Overview Content -->
                            <div class="row">
                                <!-- Job Order Details Section -->
                                <div class="col-md-4">
                                    <div class="card border-primary mb-4">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0"><i class="fas fa-briefcase me-2"></i>Job Order Details</h6>
                                        </div>
                                        <div class="card-body">
                                            <h6 id="job-title">Loading...</h6>
                                            <p class="text-muted mb-2" id="job-type">Loading...</p>
                                            <div class="mb-2">
                                                <small class="text-muted"><i class="fas fa-map-marker-alt me-1"></i></small>
                                                <span id="job-location">Loading...</span>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted"><i class="fas fa-calendar me-1"></i></small>
                                                <span id="job-created">Loading...</span>
                                            </div>
                                            <div class="mb-2">
                                                <span class="badge bg-success" id="job-status">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Applicant Details Section -->
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Professional Summary</h6>
                                            <p id="professional-summary">Loading...</p>
                                            

                                            
                                            <h6>Languages</h6>
                                            <div id="languages" class="mb-3">
                                                <span class="badge bg-info me-1 mb-1">Loading...</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Work Experience</h6>
                                            <div id="work-experience" class="timeline-small">
                                                <div class="text-muted">Loading work experience...</div>
                                            </div>
                                            
                                            <h6>Education</h6>
                                            <div id="education" class="timeline-small">
                                                <div class="text-muted">Loading education...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex gap-2 justify-content-end">
                                        <button type="button" class="btn btn-success" onclick="showApplicantAction(window.currentApplicant?.id, 'approve')">
                                            <i class="fas fa-check me-2"></i>Approve
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="showApplicantAction(window.currentApplicant?.id, 'interview')">
                                            <i class="fas fa-calendar-alt me-2"></i>Interview
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick="showApplicantAction(window.currentApplicant?.id, 'reject')">
                                            <i class="fas fa-times me-2"></i>Reject
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Applicant Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="action-form">
                        <input type="hidden" id="action-type" name="actionType">
                        
                        <div class="mb-3">
                            <label for="action-reason" class="form-label">Reason *</label>
                            <select class="form-select" id="action-reason" name="reason" required>
                                <!-- Options populated by JavaScript -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="action-notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="action-notes" name="notes" rows="4" placeholder="Add any additional comments..."></textarea>
                        </div>
                        
                        <div class="mb-3" id="interview-scheduling" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="interview-date" class="form-label">Interview Date</label>
                                    <input type="date" class="form-control" id="interview-date" name="interviewDate">
                                </div>
                                <div class="col-md-6">
                                    <label for="interview-time" class="form-label">Interview Time</label>
                                    <input type="time" class="form-control" id="interview-time" name="interviewTime">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitApplicantAction()">Submit</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Client Assessment Scorecard Modal -->
    <div class="modal fade" id="scorecardModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Client Assessment Scorecard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="scorecard-form">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Technical Competency</h6>
                                <div class="mb-3">
                                    <label class="form-label">Technical Skills (1-5)</label>
                                    <select class="form-select" name="technical_skills" required>
                                        <option value="">Select Rating</option>
                                        <option value="5">5 - Exceptional</option>
                                        <option value="4">4 - Above Average</option>
                                        <option value="3">3 - Satisfactory</option>
                                        <option value="2">2 - Below Average</option>
                                        <option value="1">1 - Inadequate</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Relevant Experience (1-5)</label>
                                    <select class="form-select" name="experience" required>
                                        <option value="">Select Rating</option>
                                        <option value="5">5 - Extensive Experience</option>
                                        <option value="4">4 - Good Experience</option>
                                        <option value="3">3 - Moderate Experience</option>
                                        <option value="2">2 - Limited Experience</option>
                                        <option value="1">1 - No Relevant Experience</option>
                                    </select>
                                </div>
                                
                                <h6>Communication & Cultural Fit</h6>
                                <div class="mb-3">
                                    <label class="form-label">English Proficiency (1-5)</label>
                                    <select class="form-select" name="english_proficiency" required>
                                        <option value="">Select Rating</option>
                                        <option value="5">5 - Native/Fluent</option>
                                        <option value="4">4 - Very Good</option>
                                        <option value="3">3 - Good</option>
                                        <option value="2">2 - Fair</option>
                                        <option value="1">1 - Poor</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Cultural Adaptability (1-5)</label>
                                    <select class="form-select" name="cultural_fit" required>
                                        <option value="">Select Rating</option>
                                        <option value="5">5 - Excellent Fit</option>
                                        <option value="4">4 - Good Fit</option>
                                        <option value="3">3 - Adequate Fit</option>
                                        <option value="2">2 - Some Concerns</option>
                                        <option value="1">1 - Poor Fit</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Professional Attributes</h6>
                                <div class="mb-3">
                                    <label class="form-label">Initiative & Problem Solving (1-5)</label>
                                    <select class="form-select" name="problem_solving" required>
                                        <option value="">Select Rating</option>
                                        <option value="5">5 - Outstanding</option>
                                        <option value="4">4 - Very Good</option>
                                        <option value="3">3 - Good</option>
                                        <option value="2">2 - Fair</option>
                                        <option value="1">1 - Poor</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Teamwork & Collaboration (1-5)</label>
                                    <select class="form-select" name="teamwork" required>
                                        <option value="">Select Rating</option>
                                        <option value="5">5 - Excellent Team Player</option>
                                        <option value="4">4 - Good Team Player</option>
                                        <option value="3">3 - Works Well in Teams</option>
                                        <option value="2">2 - Some Team Skills</option>
                                        <option value="1">1 - Poor Team Skills</option>
                                    </select>
                                </div>
                                
                                <h6>Overall Assessment</h6>
                                <div class="mb-3">
                                    <label class="form-label">Overall Rating (1-5)</label>
                                    <select class="form-select" name="overall_rating" required>
                                        <option value="">Select Overall Rating</option>
                                        <option value="5">5 - Highly Recommend</option>
                                        <option value="4">4 - Recommend</option>
                                        <option value="3">3 - Consider with Reservations</option>
                                        <option value="2">2 - Not Recommended</option>
                                        <option value="1">1 - Strongly Not Recommended</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Final Decision</label>
                                    <select class="form-select" name="final_decision" required>
                                        <option value="">Select Decision</option>
                                        <option value="approve">Approve - Move to Letter of Offer</option>
                                        <option value="reject">Reject - Return to Pool</option>
                                        <option value="hold">Hold - Need More Information</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6>Additional Comments</h6>
                                <div class="mb-3">
                                    <label class="form-label">Detailed Assessment Notes</label>
                                    <textarea class="form-control" name="assessment_notes" rows="4" placeholder="Provide detailed feedback on the candidate's suitability for the position..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Areas of Concern (if any)</label>
                                    <textarea class="form-control" name="concerns" rows="3" placeholder="List any areas where the candidate may need additional support or training..."></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="save-scorecard-btn">Save Assessment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Viewer Modal -->
    <div class="modal fade" id="documentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentModalTitle">Document Viewer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="document-viewer" class="text-center">
                        <p>Document viewer will be implemented here</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="download-document">
                        <i class="fas fa-download me-1"></i>Download
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/hubspot-api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentApplicant = null;
        let jobOrderId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded fired');
            
            // Check authentication
            if (!isAuthenticated()) {
                console.log('Not authenticated, redirecting');
                window.location.href = 'index.html';
                return;
            }
            
            console.log('Authentication passed');
            
            // Wait for scripts to load and then initialize
            setTimeout(async () => {
                try {
                    // Check if App class is available
                    if (typeof App === 'undefined') {
                        console.error('App class not found, falling back to direct initialization');
                        await initializeApplicantPageDirect();
                        return;
                    }
                    
                    console.log('App class found, initializing...');
                    window.app = new App();
                    console.log('App initialized');
                    await window.app.initialize();
                    console.log('App initialization completed');
                } catch (error) {
                    console.error('Failed to initialize app:', error);
                    console.log('Falling back to direct initialization');
                    await initializeApplicantPageDirect();
                }
            }, 100);
        });

        // Direct initialization fallback
        async function initializeApplicantPageDirect() {
            console.log('Direct initialization started');
            
            try {
                // Load user profile
                await loadUserProfile();
                console.log('User profile loaded');
                
                // Get applicant ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const applicantId = urlParams.get('id');
                
                if (!applicantId) {
                    alert('No applicant specified');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                console.log('Loading applicant details for ID:', applicantId);
                
                // Initialize HubSpot API
                const hubspotAPI = new HubSpotAPI();
                
                // Load applicant details directly
                const applicant = await hubspotAPI.getCandidate(applicantId);
                console.log('Applicant data received:', applicant);
                
                if (!applicant) {
                    throw new Error('No applicant data received');
                }
                
                // Update the page with applicant data
                updateApplicantPage(applicant);
                
                // Load job order if available
                const jobOrderId = urlParams.get('jobOrderId');
                if (jobOrderId) {
                    const jobOrder = await hubspotAPI.getJobOrder(jobOrderId);
                    updateJobOrderCard(jobOrder);
                }
                
                console.log('Direct initialization completed successfully');
                
            } catch (error) {
                console.error('Direct initialization failed:', error);
                showAlert('danger', 'Failed to load applicant details: ' + error.message);
            }
        }

        // Update applicant page with data
        function updateApplicantPage(applicant) {
            console.log('Updating applicant page with data:', applicant);
            
            // Update header information
            const nameEl = document.getElementById('applicant-name');
            if (nameEl) nameEl.textContent = `${applicant.first_name || 'Unknown'} ${applicant.last_name || 'Applicant'}`;
            
            const ageEl = document.getElementById('applicant-age');
            if (ageEl) ageEl.textContent = applicant.age || 'N/A';
            
            const locationEl = document.getElementById('applicant-location');
            if (locationEl) locationEl.textContent = applicant.location || 'N/A';
            
            const emailEl = document.getElementById('applicant-email');
            if (emailEl) emailEl.textContent = applicant.email || 'N/A';
            
            const phoneEl = document.getElementById('applicant-phone');
            if (phoneEl) phoneEl.textContent = applicant.phone || 'N/A';
            
            const statusEl = document.getElementById('applicant-status');
            if (statusEl) statusEl.textContent = applicant.status || 'N/A';
            
            const summaryEl = document.getElementById('applicant-summary');
            if (summaryEl) summaryEl.textContent = applicant.summary || 'No summary available';
            
            // Update professional summary
            const profSummaryEl = document.getElementById('professional-summary');
            if (profSummaryEl) profSummaryEl.textContent = applicant.summary || 'No professional summary available';
            
            // Update applied date
            const appliedDateEl = document.getElementById('applied-date');
            if (appliedDateEl) {
                const appliedDate = applicant.created_date || applicant.createdate || new Date().toISOString();
                appliedDateEl.textContent = new Date(appliedDate).toLocaleDateString();
            }
            
            const appStatusEl = document.getElementById('application-status');
            if (appStatusEl) appStatusEl.textContent = applicant.status || 'N/A';
            

            
            // Update languages
            const languagesEl = document.getElementById('languages');
            if (languagesEl) {
                const languages = applicant.languages || ['English'];
                if (Array.isArray(languages) && languages.length > 0) {
                    languagesEl.innerHTML = languages.map(lang => 
                        `<span class="badge bg-info me-1 mb-1">${lang ? lang.toString().trim() : ''}</span>`
                    ).join('');
                } else {
                    languagesEl.innerHTML = '<span class="badge bg-info me-1 mb-1">English</span>';
                }
            }
            
            // Store for action buttons
            window.currentApplicant = applicant;
            
            console.log('Applicant page updated successfully');
        }
        
        // Update job order card
        function updateJobOrderCard(jobOrder) {
            console.log('Updating job order card:', jobOrder);
            
            const titleEl = document.getElementById('job-title');
            if (titleEl) titleEl.textContent = jobOrder.title || 'Job Title';
            
            const typeEl = document.getElementById('job-type');
            if (typeEl) typeEl.textContent = jobOrder.position_type || 'Position Type';
            
            const locationEl = document.getElementById('job-location');
            if (locationEl) locationEl.textContent = jobOrder.location || 'Location';
            
            const createdEl = document.getElementById('job-created');
            if (createdEl) {
                const createdDate = jobOrder.created_date || new Date().toISOString();
                createdEl.textContent = new Date(createdDate).toLocaleDateString();
            }
            
            const statusEl = document.getElementById('job-status');
            if (statusEl) statusEl.textContent = jobOrder.status || 'Active';
        }
        
        // Alert function - now displays below header
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const alertContainer = document.getElementById('alert-container');
            if (alertContainer) {
                alertContainer.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            } else {
                // Fallback to old method if container not found
                const container = document.querySelector('.container-fluid');
                if (container) {
                    container.insertBefore(alertDiv, container.firstChild);
                }
            }
        }

        // Show applicant action modal (like on job-order page)
        function showApplicantAction(applicantId, actionType) {
            if (!applicantId || !window.currentApplicant) {
                alert('No applicant data available for action');
                return;
            }
            
            const applicant = window.currentApplicant;
            
            // Set modal title and populate reason options
            const modal = document.getElementById('actionModal');
            const title = document.getElementById('actionModalTitle');
            const reasonSelect = document.getElementById('action-reason');
            const interviewDiv = document.getElementById('interview-scheduling');
            
            document.getElementById('action-type').value = actionType;
            reasonSelect.innerHTML = '';
            interviewDiv.style.display = 'none';
            
            switch(actionType) {
                case 'approve':
                    title.textContent = 'Approve Applicant';
                    reasonSelect.innerHTML = `
                        <option value="">Select reason for approval</option>
                        <option value="skills-excellent">Excellent skills match</option>
                        <option value="experience-relevant">Relevant experience</option>
                        <option value="cultural-fit">Good cultural fit</option>
                        <option value="qualifications">Strong qualifications</option>
                        <option value="interview-performance">Great interview performance</option>
                    `;
                    break;
                case 'reject':
                    title.textContent = 'Reject Applicant';
                    reasonSelect.innerHTML = `
                        <option value="">Select reason for rejection</option>
                        <option value="skills-mismatch">Skills mismatch</option>
                        <option value="experience-insufficient">Insufficient experience</option>
                        <option value="overqualified">Overqualified</option>
                        <option value="salary-expectations">Salary expectations too high</option>
                        <option value="availability">Availability issues</option>
                        <option value="communication">Communication issues</option>
                        <option value="cultural-fit">Cultural fit concerns</option>
                        <option value="other">Other</option>
                    `;
                    break;
                case 'interview':
                    title.textContent = 'Schedule Interview';
                    reasonSelect.innerHTML = `
                        <option value="">Select interview type</option>
                        <option value="phone-screening">Phone screening</option>
                        <option value="video-interview">Video interview</option>
                        <option value="in-person">In-person interview</option>
                        <option value="technical-assessment">Technical assessment</option>
                        <option value="final-interview">Final interview</option>
                    `;
                    interviewDiv.style.display = 'block';
                    break;
            }
            
            new bootstrap.Modal(modal).show();
        }

        // Submit applicant action (like on job-order page)
        async function submitApplicantAction() {
            const form = document.getElementById('action-form');
            const formData = new FormData(form);
            
            // Validate required fields
            if (!formData.get('reason')) {
                alert('Please select a reason');
                return;
            }
            
            const actionData = {
                applicantId: window.currentApplicant?.id,
                actionType: formData.get('actionType'),
                reason: formData.get('reason'),
                notes: formData.get('notes'),
                interviewDate: formData.get('interviewDate')
            };
            
            // Submit to HubSpot
            try {
                console.log('Submitting action data:', actionData);
                const response = await submitApplicantActionToHubSpot(actionData);
                console.log('Action response:', response);
                
                // Close modal and show success
                bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
                
                showAlert('success', `Applicant action "${actionData.actionType}" submitted successfully! ${response.workflow_triggered ? 'Workflow triggered.' : ''}`);
                
                // Reload applicant details to show updated status
                setTimeout(() => {
                    if (window.currentApplicant?.id) {
                        location.reload();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting applicant action:', error);
                console.error('Error details:', error.message, error.stack);
                showAlert('danger', `Failed to submit applicant action: ${error.message || 'Please try again.'}`);
            }
        }

        // Function to submit applicant action to HubSpot using custom object API
        async function submitApplicantActionToHubSpot(actionData) {
            // Map action types to proper pipeline stages and workflows
            let pipelineStage, workflowId;
            
            switch(actionData.actionType) {
                case 'approve':
                    pipelineStage = '1530375619';
                    workflowId = '2509546972';
                    break;
                case 'reject':
                    pipelineStage = '1076100933';
                    workflowId = '2509546994';
                    break;
                case 'interview':
                    pipelineStage = 'interviewing';
                    workflowId = null; // No specific workflow for interview
                    break;
                default:
                    throw new Error('Invalid action type');
            }

            console.log('Submitting to API endpoint:', `/api/hubspot/objects/2-184526441/${actionData.applicantId}/actions`);
            console.log('Request body:', {
                action: actionData.actionType,
                pipeline_stage: pipelineStage,
                workflow_id: workflowId,
                applicantId: actionData.applicantId,
                reason: actionData.reason,
                notes: actionData.notes,
                interview_date: actionData.interviewDate
            });

            const response = await fetch(`/api/hubspot/objects/2-184526441/${actionData.applicantId}/actions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('tprc_token')}`
                },
                body: JSON.stringify({
                    action: actionData.actionType,
                    pipeline_stage: pipelineStage,
                    workflow_id: workflowId,
                    applicantId: actionData.applicantId,
                    reason: actionData.reason,
                    notes: actionData.notes,
                    interview_date: actionData.interviewDate
                })
            });

            console.log('Response status:', response.status);
            
            if (!response.ok) {
                let errorMessage = 'Failed to submit applicant action';
                try {
                    const error = await response.json();
                    console.error('API error response:', error);
                    errorMessage = error.message || error.error || errorMessage;
                } catch (parseError) {
                    console.error('Failed to parse error response:', parseError);
                    errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            const result = await response.json();
            console.log('Success response:', result);
            return result;
        }
    </script>
</body>
</html>
